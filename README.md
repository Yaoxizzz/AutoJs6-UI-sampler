# AutoJs6 UI 取样器（点选/框选 → 截图 + 控件候选 + 点击代码）

这是一个给 **<span style="word-break:keep-all;white-space:nowrap">[AutoJs6](https://github.com/SuperMonster003/AutoJs6)</span>  （二改版本）** 写的「UI 取样器」脚本：

* 你在屏幕上 **点选** 或 **框选** 一块区域
* 脚本会采集该区域相关的：

  * 全屏截图（screen.png）
  * 选区截图（crop.png）
  * 控件候选列表（nodes.json）
  * 采集元信息（meta.json）
  * 自动生成的点击代码候选（code.txt）

> 目标：帮助你快速定位“哪个控件能点 / 怎么写选择器”，而不是录制脚本。
  * PS：如果其他版本的AutoJS不兼容，可以把源代码以及报错日志丢给AI，让AI帮你修改【不做兼容修改，程序报错在提交】
---

## 功能特性

* ✅ **点选/框选取样**：支持按点采集与矩形框采集
* ✅ **手动命名输出**：采集完成后弹出系统输入框要求填写“采集名”，不填/取消就不输出
* ✅ **不自动改名**：采集名目录已存在会提示重新输入
* ✅ **二改兼容**：

  * 不使用 `"ui";`（避免启动空白 Activity）
  * 不调用 `setTouchable()`（部分二改没有该 API）
  * 避免 UI 线程阻塞（sleep/耗时均放子线程）
  * 截图权限优先 `requestScreenCaptureAsync()`
* ✅ **悬浮窗更友好**：不透明卡片背景、可拖动、可最小化、点选/框选时自动缩小避免遮挡
* ✅ **打开结果多方式**：复制路径 / 系统打开 / MT 管理器打开（会先复制路径）
* ✅ **全程日志**：关键动作都会在 AutoJs6 日志里输出，方便排错

---

## 环境要求

* Android 8+（推荐 10+）
* AutoJs6（官方/二改均可，脚本已尽量做兼容）
* **已开启无障碍服务**（AutoJs6 的无障碍）
* **已授予截图权限**（首次运行会弹系统截图授权）

> 设备 Root / LSPosed 不是必须，但对“防截图页面/系统限制”等场景会更友好。

---

## 安装与使用

1. 把脚本放到 AutoJs6 脚本目录并运行。
2. 首次运行：

   * 按提示开启无障碍服务
   * 按提示授予截图权限
3. 在悬浮窗选择：

   * **点选**：点一下目标位置
   * **框选**：按住拖动框出目标区域
4. 采集结束后会弹出系统输入框：

   * 输入 **采集名（必填）**
   * 确认后保存到 Documents
   * 取消/空输入 → 不保存，临时数据会丢弃
5. 点击「打开结果」可选择：

   * 复制路径
   * 系统打开
   * 用 MT 管理器打开（会先复制路径，方便你粘贴到地址栏）

---

## 输出目录与文件说明

输出目录：

```
/storage/emulated/0/Documents/AutoJs6_UI_Sampler/<采集名>/
```

目录内文件：

* `screen.png`：全屏截图
* `crop.png`：点选/框选区域截图
* `meta.json`：采集元信息（时间、模式、坐标/矩形、包名/Activity、设备信息、告警）
* `nodes.json`：候选控件（已去重并按“更可能稳定/可点击”排序）
* `code.txt`：基于候选控件自动生成的点击代码片段（多套方案）

> 采集过程会先写入临时目录；只有在你输入采集名并确认后才会输出到 Documents。

---

## `code.txt` 里有哪些点击方案？

脚本会尽量从“更稳”到“兜底”生成多种写法，例如：

* 优先：`id("...")` + bounds 约束
* 其次：`text("...")` / `desc("...")` + bounds 约束
* 父级可点兜底：如果目标控件 `clickable=false`，会尝试找到可点击父节点
* 最后兜底：`click(x, y)` 坐标点击（同时给出屏幕比例 x/y 便于适配分辨率）

---

## 常见问题（FAQ）

### 1) 为什么不在悬浮窗里输入采集名？

悬浮窗里的 `input` 在很多 ROM/版本上拿不到输入法焦点，也不会弹键盘或复制粘贴菜单。
所以这里改为 **系统弹窗输入**（`dialogs.rawInput()`），可靠性更高。

### 2) 采不到控件（nodes 为空/很少）怎么办？

可能原因：

* WebView/Canvas/游戏渲染层（无障碍取不到树）
* 窗口切换瞬间根节点为空
* 系统省电/安全策略限制无障碍
* 控件被过滤、resource-id 不稳定

建议：

* 重新采一次（尤其在界面稳定后）
* 用框选扩大一点范围
* 最终用 `click(x,y)` 或找图兜底

### 3) 截图是黑的/空的？

可能是“防截图页面”或系统限制。Root/LSPosed 相关模块可能能绕过。

---

## 开发说明

脚本内部做了不少兼容处理：

* `requestScreenCaptureAsync()` 优先；缺失则子线程调用同步 `requestScreenCapture()`
* 所有耗时操作在 `threads.start()` 子线程执行，避免 UI 线程阻塞报错
* 目录创建使用“硬创建”方式，避免 `images.save` 报 `ENOENT`

---

## 免责声明

本脚本仅用于学习与自动化测试辅助。请遵守相关法律法规与目标应用的使用条款。
